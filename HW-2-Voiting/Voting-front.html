<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voting</title>
</head>

<div id="statistics">
  <h3>Статистика</h3>
  <p data-id="nedzen">Не дзен: <span></span></p>
  <p data-id="dzen">Дзен: <span></span></p>
  <p data-id="pdzen">Полный дзен: <span></span></p>
</div>

<form action="#">
  <!--  method=POST action="http://178.172.195.18:7580/vote" -->
  <p><b>Какое у вас состояние разума?</b></p>
  <div id="radio-block"> </div>
  <button onclick="configureFormData(event)">Выбрать</button>
</form>

<body>
  <script>
    async function getVariantsData() {
      const variantsUrl = `http://178.172.195.18:7580/variants`; // http://178.172.195.18:7580/variants
      const votingData = await fetch(variantsUrl)
        .then(response => response.json())
        .then(data => {
          createForm(data);
        })
        .catch((error) => {
          console.log('Request variants failed', error)
        });
    }
    getVariantsData();

    async function createStatData() {
      const statUrl = `http://178.172.195.18:7580/stat`; // http://localhost:7580
      const statData = await fetch(statUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(res => {
          setStatistics(res);
        })
        .catch((error) => {
          console.log('Request stat failed', error)
        });
    }

    createStatData();

    function createForm(formData) {
      const elem = document.getElementById('radio-block');
      for (let i in formData) {
        elem.appendChild(document.createElement("p")).innerHTML =
          `<input name="selection" type="radio" value="${formData[i].id}"> ${formData[i].text}</>`;
      }
    }

    function setStatistics(res) {
      const statisticList = document.querySelectorAll('div#statistics p');
      for (let i in res) {
        if (res[i].id === statisticList[i].dataset.id) {
          statisticList[i].childNodes[1].textContent = ` ${res[i].count}`;

        }
      }
    }

    function configureFormData(event) {
      event.preventDefault();
      const inputList = document.querySelectorAll('div#radio-block input');
      const updatedFormList = [];
      inputList.forEach(e => {
        updatedFormList.push({
          id: e.value,
          checked: e.checked
        });
      });
      sendFormData(updatedFormList);
    }

    async function sendFormData(formData) {
      const voteUrl = `http://178.172.195.18:7580/vote`; // http://localhost:7580
      const voteData = await fetch(voteUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json;charset=utf-8'
        },
        body: JSON.stringify(formData)
      });
      if (voteData.status !== 200) {
        console.log(`Looks like there was a problem. Status Code:  ${response.status}`);
        return;
      }
      const statCall = await createStatData();
    }
  </script>
</body>

</html>